# 🫀 가변 리드 조합에서의 단일 딥러닝 모델을 활용한 12리드 심전도 재구성  
**12-lead Electrocardiogram Reconstruction Using a Single Deep Learning Model with Variable Lead Combinations**

## 연구/프로젝트 개요

웨어러블 심전도 기기는 주로 **소수의 사지 유도(1–3리드)** 만 제공하는 반면, 실제 임상 진단은 여전히 **표준 12리드 ECG**에 의존함.  
본 프로젝트의 목표는 다음과 같음.

- **서로 다른 입력 리드 조합(C1–C6)** 에서 **하나의 딥러닝 모델**로 12리드 ECG를 재구성할 수 있는지 평가  
- **MIMIC-IV-ECG**로 학습하고, **PTB-XL**에서 외부 검증 수행  
- 리드 수/조합/해부학적 위치에 따른 **재구성 난이도 차이 정량·정성 분석**  
- 웨어러블/부분 리드 환경에서 사용할 수 있는 **범용(Universal) 12리드 재구성 모델**의 가능성 검토

## 전처리 파이프라인

![전처리 파이프라인](figs/전체%20파이프라인.png)

## 데이터셋

PhysioNet에서 제공하는 두 공개 ECG 데이터셋을 사용.

### 1. MIMIC-IV-ECG: Diagnostic Electrocardiogram Matched Subset

- 약 **16만 명**의 환자, 약 **80만 개**의 진단용 ECG  
- 모든 기록: **10초 길이**, **500 Hz 샘플링 주파수**, **표준 12리드**
- 본 연구 설정
  - 12리드 중 **하나라도 전 구간 진폭이 0인 리드가 존재하는 레코드 제거**
  - 그 중 **30,000개 레코드**를 선택하여 전처리
  - 레코드 단위로 무작위 셔플 후 **8:1:1 분할**
    - Train: 24,000
    - Validation: 3,000
    - Test: 3,000  
    - 동일 환자의 레코드가 서로 다른 분할에 섞이지 않도록 구성

### 2. PTB-XL: A large publicly available electrocardiography dataset

- **18,869명** 환자, **21,799개** 12리드 ECG
- 모든 기록: **10초 길이**, **500 Hz**
- 본 연구 설정
  - MIMIC-IV-ECG와 **동일한 전처리 파이프라인** 적용
  - 총 **10,000개 레코드**를 외부 검증에 사용

> ⚠️ 본 연구에 사용된 모든 데이터세트는 공개적으로 이용 가능합니다. 다음 링크를 통해 접근하실 수 있습니다.
> ﻿https://physionet.org/content/mimic-iv-ecg/1.0/<br>
> ﻿https://physionet.org/content/ptb-xl/1.0.3/



---

## 전처리 파이프라인

두 데이터셋(MIMIC-IV-ECG, PTB-XL)에 **동일한 전처리**를 적용.

1. **WFDB 로드 및 메타데이터 확보**
   - 신호, 샘플링 주파수, 단위, 채널 이름 등
2. **0 진폭 리드 제거**
   - 12리드 중 **하나라도 전체 구간이 0**인 경우 해당 레코드 제외
3. **표준 12리드 매핑 및 정렬**
   - 리드 이름을 표준 12리드  
     `I, II, III, aVR, aVL, aVF, V1–V6`  
     로 매핑 후 순서 통일
4. **단위 통일 (mV)**
   - μV → 1,000으로 나눔  
   - V → 1,000을 곱함  
   → 모든 리드가 **mV 단위**를 갖도록 통일
5. **0.5–60 Hz 대역통과 필터(Bandpass Filter)**
   - 0.5 Hz 미만의 기저선 드리프트 제거
   - 60 Hz 초과의 근전도·환경 잡음 제거
6. **고정 길이 윈도 분할**
   - 전체 파형을 길이 **1,024 샘플**의 윈도우로 순차 분할
   - 각 윈도우를 하나의 **학습/평가 샘플**로 사용
--
![전처리](figs/전처리.png)
--

## 입력 리드 조합 (C1–C6) 및 Lead Dropout

모델 입력은 다음과 같은 **6가지 리드 조합(Combo)** .

### 표 1. 입력 리드 조합(C1–C6)

| 조합 | 리드 수 | 리드 구성                             |
|------|--------|----------------------------------------|
| C1   | 2      | II, V1                                |
| C2   | 3      | I, II, V3                             |
| C3   | 4      | I, II, V2, V4                         |
| C4   | 5      | aVR, V3, V4, V5, V6                  |
| C5   | 6      | III, aVL, aVF, V1, V2, V3            |
| C6   | 7      | I, II, III, aVL, aVR, aVF, V2        |

- 학습 시 **lead dropout 전략**을 사용:
  - 각 학습 윈도우마다 C1–C6 중 **하나를 균등 확률로 무작위 선택**
  - 선택된 조합에 해당하는 리드의 신호만 **입력으로 보존**
  - 나머지 리드는 **0으로 마스킹**하여 결측 상태를 시뮬레이션
- 에폭별로 각 조합의 사용 빈도를 추적한 결과,
  - 모든 조합이 **통계적으로 균등하게 샘플링**됨을 확인

> 검증 단계에서는 정보량이 가장 적은 C1(II, V1)을 고정 입력으로 사용하여,  
> 최소 리드 구성에서의 수렴 여부 및 과적합을 모니터링.
---

## 콤보별 마스크 예시
C1-II+V1
![마스크](figs/mask%20C1-C6/mask_C1.png)
C2-I+II+V3
![마스크](figs/mask%20C1-C6/mask_C2.png)
C3-I+II+V2+V4
![마스크](figs/mask%20C1-C6/mask_C3.png)
C4-aVR+V3+V4+V5+V6
![마스크](figs/mask%20C1-C6/mask_C4.png)
C5-III+aVL+aVF+V1+V2+V3
![마스크](figs/mask%20C1-C6/mask_C5.png)
C6-I+II+III+aVL+aVR+aVF+V2
![마스크](figs/mask%20C1-C6/mask_C6.png)

## 모델 구조

본 프로젝트의 기본 모델은 **ResNet–U-Net 구조의 1차원 인코더–디코더 네트워크**.

![모델 구조](figs/모델%20구조.png)

- **전반적인 구조**
  - 다운샘플링을 수행하는 `DRBlock`
  - 업샘플링을 수행하는 `URBlock`
  - 두 모듈이 대칭적으로 연결된 **U-Net 형태**

- **주요 설정**
  - 커널 크기: `13`
  - 스트라이드: `1/2` (계층적으로 특징 압축 및 복원)
  - 활성화 함수: **GELU**
  - 정규화: **Layer Normalization + Instance Normalization** 동시 적용
  - **Residual connection**으로 학습 안정성과 표현력 향상
  - 인코더–디코더 간 **skip connection**으로 다단계 특징을 직접 전달  
    → 심전도 파형의 **형태학적 정보** 보존

이를 통해,
- 깊은 계층에서도 **학습 안정성**을 유지하고  
- **고해상도 출력**을 복원할 수 있도록 설계.

---

## 평가 지표 및 정량 결과

### 사용한 평가 지표

- **MSE** (Mean Squared Error)  
- **RMSE** (Root MSE)  
- **PCC** (Pearson Correlation Coefficient)  
- **SSIM** (Structural Similarity Index Measure, 형태학적 유사도)

### C1–C6 조합별 12리드 재구성 성능 (PTB-XL)

| Combo | MSE     | RMSE    | PCC    | SSIM   |
|-------|---------|--------|--------|--------|
| C1    | 0.0174  | 0.0949 | 0.8707 | 0.9548 |
| C2    | 0.0129  | 0.7433 | 0.9649 | 0.9678 |
| C3    | 0.0121  | 0.0708 | 0.9760 | 0.9695 |
| C4    | 0.0140  | 0.0838 | 0.8705 | 0.9586 |
| C5    | 0.0120  | 0.0705 | 0.9768 | 0.9695 |
| C6    | 0.0137  | 0.0768 | 0.9595 | 0.9660 |

**핵심 해석**

- **C3, C5**
  - 가장 낮은 MSE/RMSE와 가장 높은 PCC/SSIM  
  → **가장 우수한 재구성 성능**
- **C1**
  - 최소 2리드 구성  
  → 가장 큰 오차 + 가장 낮은 상관계수  
  → 웨어러블 유사 환경에서 **12리드 동시 복원의 본질적 난이도**를 보여줌.
- **C4**
  - 리드 수가 더 많음에도 C2·C3보다 낮은 성능  
  → **리드 수 증가가 항상 성능 향상으로 이어지지는 않음**을 시사

---

## 리드 유형별 성능 분석

### 1. 사지 리드별 재구성 성능 (C1–C6 평균)

| Lead | MSE     | RMSE    | PCC    | SSIM   |
|------|---------|--------|--------|--------|
| I    | 0.0053  | 0.0522 | 0.9653 | 0.9947 |
| II   | 0.0052  | 0.0472 | 0.9858 | 0.9943 |
| III  | 0.0094  | 0.0731 | 0.8615 | 0.9111 |
| aVR  | 0.0031  | 0.0348 | 0.9913 | 0.9966 |
| aVL  | 0.0063  | 0.0613 | 0.8863 | 0.9819 |
| aVF  | 0.0058  | 0.0546 | 0.9323 | 0.9803 |

- aVR, II, I 리드는
  - **낮은 MSE**, **높은 PCC/SSIM**을 보여 안정적인 재구성
- 사지 리드 전반은
  - 서로 **강한 선형 관계**와 **높은 상관성**을 가지며
  - 전반적인 **전기축·리듬**을 반영  
  → 일부 리드만 주어져도 나머지를 **상대적으로 잘 근사 가능**

### 2. 흉부 리드별 재구성 성능 (C1–C6 평균)

| Lead | MSE     | RMSE    | PCC    | SSIM   |
|------|---------|--------|--------|--------|
| V1   | 0.0139  | 0.0831 | 0.9415 | 0.9789 |
| V2   | 0.0320  | 0.1247 | 0.9455 | 0.9343 |
| V3   | 0.0303  | 0.1210 | 0.9338 | 0.9347 |
| V4   | 0.0234  | 0.1116 | 0.9274 | 0.9524 |
| V5   | 0.0174  | 0.0977 | 0.9297 | 0.9562 |
| V6   | 0.0121  | 0.0800 | 0.9361 | 0.9569 |

- **V1, V6**
  - 비교적 **낮은 MSE**, **높은 PCC·SSIM** → 재구성 **용이**
- **V2–V4**
  - 평균 MSE가 가장 크고, PCC도 상대적으로 낮음  
  → 전중격/전벽 영역의 **국소적 전위 변화와 급격한 기울기** 때문에  
    재구성 난이도가 가장 높은 리드로 확인됨

---

## 파형 형태 기반 정성 평가

C1–C6에 대해 임의의 2초 구간을 시각화한 결과:

![결과](figs/C1-C6/C1-II%2BV1.png)
![결과](figs/C1-C6/C2-I%2BII%2BV3.png)
![결과](figs/C1-C6/C3-I%2BII%2BV2%2BV4.png)
![결과](figs/C1-C6/C4-aVR%2BV3%2BV4%2BV5%2BV6.png)
![결과](figs/C1-C6/C5-III%2BaVL%2BaVF%2BV1%2BV2%2BV3.png)
![결과](figs/C1-C6/C6-I%2BII%2BIII%2BaVL%2BaVR%2BaVF%2BV2.png)

- 대부분 리드에서
  - **P파, QRS, T파의 시점·극성**이 실제 신호와 거의 일치
  - QRS 폭과 ST 분절의 전체적인 형태도 **높은 수준으로 보존**
- V2–V4 일부에서는
  - R파 진폭이 실제 신호 대비 **과대/과소 재구성**되는 경향  
  → 해당 리드에서 **MSE가 상대적으로 높은 결과**와 정합

- **C1 (최소 2리드 구성)**:
  - 심박 주기와 기본 파형은 잘 맞으나  
  - 일부 사지·흉부 리드에서 **R파 진폭 및 기저선 주변 노이즈 차이**가 더 두드러짐.
- **C3, C5**:
  - 12리드 파형이 **거의 완전히 중첩**될 정도의 유사도  
  → 높은 PCC, 낮은 RMSE, 높은 SSIM과 **일관된 시각적 결과**
